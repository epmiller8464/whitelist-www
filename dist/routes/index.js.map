{"version":3,"sources":["../../routes/index.js"],"names":["express","require","router","Router","geoip","csurf","cookie","nets","Whitelist","moment","mail","get","req","res","next","contributionAmounts","loadContributionAmounts","render","title","site_key","process","env","RECAPTCHA_KEY","csrfToken","geo","lookup","query","ip","status","json","post","hasCookie","success","body","response","remoteip","email","error","validateSubmitter","err","result","data","cryptoType","purchaseAmount","record","save","doc","Date","now","httpOnly","maxAge","add","unix","signed","secure","NODE_ENV","path","to","name","split","then","catch","e","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","value","display","token","cookies","signedCookies","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["const express = require('express')\nconst router = express.Router()\nconst geoip = require('geoip-lite')\nconst csurf = require('csurf')({cookie: true})\nconst nets = require('nets')\nconst {Whitelist} = require('../lib/model')\nconst moment = require('moment')\nconst mail = require('../lib/mail')\n/* GET home page. */\nrouter.get('/', csurf, function (req, res, next) {\n  let contributionAmounts = loadContributionAmounts()\n  res.render('index', {\n    title: 'Swytch',\n    contributionAmounts: contributionAmounts,\n    site_key: process.env.RECAPTCHA_KEY,\n    csrfToken: req.csrfToken()\n  })\n})\nrouter.get('/geo-locate', (req, res, next) => {\n  var geo = geoip.lookup(req.query.ip)\n  return res.status(200).json(geo)\n})\n\nrouter.post('/whitelist', csurf, (req, res, next) => {\n\n  if (hasCookie(req)) {\n    return res.status(200).json({success: true})\n  }\n\n  let body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n  let email = req.body.email\n\n  if ((!body.response || !email)) {\n    return res.status(400).json({error: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, (err, result) => {\n    if (err || !result.success) {\n      return res.status(400).json({error: 'Validation failed.'})\n    }\n    var data = {\n      email: req.body.email,\n      ip: req.ip,\n      cryptoType: req.body.cryptoType,\n      purchaseAmount: req.body.purchaseAmount\n    }\n    const record = new Whitelist(data)\n    record.save((err, doc) => {\n      if (err) {\n        return res.status(400).json({error: 'Invalid parameters'})\n      }\n\n      res.cookie('_wl', Date.now(), {\n        httpOnly: true,\n        maxAge: moment().add(90, 'days').unix(),\n        signed: true,\n        secure: process.env.NODE_ENV !== 'development',\n        path: '/'\n      })\n      res.cookie('_wl_ip', req.ip, {\n        httpOnly: true,\n        maxAge: moment().add(90, 'days').unix(),\n        signed: true,\n        secure: process.env.NODE_ENV !== 'development',\n        path: '/'\n      })\n      mail({to: doc.email, name: doc.email.split('@')[0]}).then((result) => {\n        return res.status(200).json({success: true})\n      }).catch((e) => {\n        return res.status(200).json({success: true})\n      })\n    })\n  })\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  let url = `https://www.google.com/recaptcha/api/siteverify?secret= ${process.env.RECAPTCHA_SECRET}&response=${recaptcha}&remoteip=${ip}`\n  let request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, (err, res, body) => {\n    return cb(err, JSON.parse(body))\n  })\n}\n\nfunction loadContributionAmounts () {\n  return [\n    {value: null, display: 'USD > 100'},\n    {value: '100-1000', display: 'USD 100 - 1,000'},\n    {value: '1000-5000', display: 'USD 1,000 - 5,000'},\n    {value: '5000-10000', display: 'USD 5,000 - 10,000'},\n    {value: '10000-50000', display: 'USD 10,000 - 50,000'},\n    {value: '50000-100000', display: 'USD 50,000 - 100,000'},\n    {value: '100000-MAX', display: 'USD +100,000'}\n  ]\n}\n\nfunction hasCookie (req) {\n  var token = null\n  if (req && req.cookies) {\n    token = req.cookies['_wl']\n    if (!token) {\n      token = req.signedCookies['_wl']\n    }\n  }\n  return token\n}\n\nmodule.exports = router\n"]}