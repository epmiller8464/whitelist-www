{"version":3,"sources":["../../routes/index.js"],"names":["express","require","router","Router","authenticate","check","validationResult","query","matchedData","sanitize","sanitizeQuery","Subscriber","User","Email","verifyToken","validate","isEmail","withMessage","trim","normalizeEmail","org","get","req","res","next","render","title","VIDEO_URL","process","env","SWYTCH_VIDEO_URL","WP_URL","WHITEPAPER_URL","team","advisors","csrfToken","logOut","user","session","locals","clearCookie","hideLogin","post","redirect","hideSignup","token","then","result","findOneAndUpdate","_id","sub","verified","err","Error","catch","message","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\nconst authenticate = require('../lib/authenticate')\nconst {check, validationResult, query} = require('express-validator/check')\nconst {matchedData, sanitize, sanitizeQuery} = require('express-validator/filter')\nconst {Subscriber, User} = require('../lib/model')\nconst {Email} = require('../lib/mail')\nconst {verifyToken} = require('../lib/jsonwebtoken')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim()]\nconst org = require('../lib/data/team')\nrouter.get('/', function (req, res, next) {\n\n  res.render('index', {\n    title: 'Swytch',\n    VIDEO_URL: process.env.SWYTCH_VIDEO_URL,\n    WP_URL: process.env.WHITEPAPER_URL,\n    team: org.team,\n    advisors: org.advisors,\n    csrfToken: req.csrfToken()\n  })\n})\n\nrouter.get('/login', function (req, res, next) {\n  req.logOut()\n  req.user = null\n  req.session = null\n  res.locals = null\n  res.clearCookie('SU_USER')\n  res.render('login', {\n    title: 'Swytch',\n    hideLogin: true,\n    csrfToken: req.csrfToken()\n  })\n})\n\nrouter.post('/logout', function (req, res, next) {\n  req.logOut()\n  req.user = null\n  req.session = null\n  res.locals = null\n  res.clearCookie('SU_USER')\n  res.redirect('/')\n})\n\nrouter.get('/sign-up', function (req, res, next) {\n\n  res.render('sign-up', {\n    title: 'Swytch',\n    hideSignup: true,\n    csrfToken: req.csrfToken()\n  })\n})\n\nrouter.get('/verify/:id', function (req, res, next) {\n  var token = req.query.token\n\n  verifyToken(token)\n  .then((result) => {\n    // TODO: blacklist the token\n    User.findOneAndUpdate({_id: result.sub}, {verified: true}, function (err, user) {\n      if (err || !user) {\n        return next(new Error('We couldn\\'t process your request at this time.'))\n      }\n\n      if (user) {\n        res.redirect('/platform/token-sale')\n      }\n    })\n  }).catch((err) => {\n    return next(err)\n  })\n})\n\nrouter.get('/error', (req, res, next) => {\n  res.render('error', {message: 'Noting to see here'})\n})\n\nmodule.exports = router\n"]}