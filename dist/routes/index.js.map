{"version":3,"sources":["../../routes/index.js"],"names":["express","require","router","Router","authenticate","check","validationResult","query","matchedData","sanitize","sanitizeQuery","Subscriber","User","Email","verifyToken","validate","isEmail","withMessage","trim","normalizeEmail","get","req","res","next","render","title","site_key","process","env","RECAPTCHA_KEY","VIDEO_URL","SWYTCH_VIDEO_URL","WP_URL","WHITEPAPER_URL","csrfToken","token","then","result","updates","verified","findByIdAndUpdate","params","id","e","u","redirect","catch","err","message","module","exports"],"mappings":"AAAA;;AACA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,SAASF,QAAQG,MAAR,EAAf;AACA,IAAMC,eAAeH,QAAQ,qBAAR,CAArB;;eACyCA,QAAQ,yBAAR,C;IAAlCI,K,YAAAA,K;IAAOC,gB,YAAAA,gB;IAAkBC,K,YAAAA,K;;gBACeN,QAAQ,0BAAR,C;IAAxCO,W,aAAAA,W;IAAaC,Q,aAAAA,Q;IAAUC,a,aAAAA,a;;gBACHT,QAAQ,cAAR,C;IAApBU,U,aAAAA,U;IAAYC,I,aAAAA,I;;gBACHX,QAAQ,aAAR,C;IAATY,K,aAAAA,K;;gBACeZ,QAAQ,qBAAR,C;IAAfa,W,aAAAA,W;;AACP,IAAMC,WAAW,CAACV,MAAM,OAAN,EAAeW,OAAf,GAAyBC,WAAzB,CAAqC,kBAArC,EAAyDC,IAAzD,GAAgEC,cAAhE,EAAD,EAAmFV,SAAS,OAAT,EAAkBS,IAAlB,EAAnF,CAAjB;;AAEAhB,OAAOkB,GAAP,CAAW,GAAX,EAAgB,UAAUC,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AACxCD,MAAIE,MAAJ,CAAW,OAAX,EAAoB;AAClBC,WAAO,QADW;AAElBC,cAAUC,QAAQC,GAAR,CAAYC,aAFJ;AAGlBC,eAAWH,QAAQC,GAAR,CAAYG,gBAHL;AAIlBC,YAAQL,QAAQC,GAAR,CAAYK,cAJF;AAKlBC,eAAWb,IAAIa,SAAJ;AALO,GAApB;AAOD,CARD;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAhC,OAAOkB,GAAP,CAAW,aAAX,EAA0B,UAAUC,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;;AAElD,MAAIY,QAAQd,IAAId,KAAJ,CAAU4B,KAAtB;;AAEArB,cAAYqB,KAAZ,EACCC,IADD,CACM,UAACC,MAAD,EAAY;AAChB,QAAIC,UAAU,EAACC,UAAU,IAAX,EAAd;;AAEA;AACA3B,SAAK4B,iBAAL,CAAuBnB,IAAIoB,MAAJ,CAAWC,EAAlC,EAAsCJ,OAAtC,EAA+C,UAAUK,CAAV,EAAaC,CAAb,EAAgB;AAC7DtB,UAAIuB,QAAJ;AAED,KAHD;AAID,GATD,EASGC,KATH,CASS,UAACC,GAAD,EAAS;AAChB,WAAOxB,KAAKwB,GAAL,CAAP;AACD,GAXD;AAYD,CAhBD;;AAkBA7C,OAAOkB,GAAP,CAAW,QAAX,EAAqB,UAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;;AAEvCD,MAAIE,MAAJ,CAAW,OAAX,EAAoB,EAACwB,SAAS,oBAAV,EAApB;AACD,CAHD;;AAKAC,OAAOC,OAAP,GAAiBhD,MAAjB","file":"index.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\nconst authenticate = require('../lib/authenticate')\nconst {check, validationResult, query} = require('express-validator/check')\nconst {matchedData, sanitize, sanitizeQuery} = require('express-validator/filter')\nconst {Subscriber, User} = require('../lib/model')\nconst {Email} = require('../lib/mail')\nconst {verifyToken} = require('../lib/jsonwebtoken')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim()]\n\nrouter.get('/', function (req, res, next) {\n  res.render('index', {\n    title: 'Swytch',\n    site_key: process.env.RECAPTCHA_KEY,\n    VIDEO_URL: process.env.SWYTCH_VIDEO_URL,\n    WP_URL: process.env.WHITEPAPER_URL,\n    csrfToken: req.csrfToken()\n  })\n})\n// router.post('/login', validate, authenticate, (req, res, next) => {\n//   next()\n// }, function (req, res, next) {\n//\n//   res.status(200).send()\n// })\n// Every validator method in the validator lib is available as a\n// method in the check() APIs.\n// You can customize per validator messages with .withMessage()\n\n// Every sanitizer method in the validator lib is available as well!\n// ...or throw your own errors using validators created with .custom()\n\n// confirm_url: buildUrl(`verify/:id?token=${token}`),\n\n// router.post('/login', authenticate, function (req, res, next) {\n//   res.render('login', {\n//     title: 'Swytch',\n//     site_key: process.env.RECAPTCHA_KEY,\n//     csrfToken: req.csrfToken()\n//   })\n// })\n\n// router.get('/verify/:id', function (req, res, next) {\n//\n//   res.render('index', {\n//     title: 'Swytch',\n//     site_key: process.env.RECAPTCHA_KEY,\n//     csrfToken: req.csrfToken()\n//   })\n// })\n\nrouter.get('/verify/:id', function (req, res, next) {\n\n  var token = req.query.token\n\n  verifyToken(token)\n  .then((result) => {\n    var updates = {verified: true}\n\n    /// TODO: blacklist the token\n    User.findByIdAndUpdate(req.params.id, updates, function (e, u) {\n      res.redirect(`/?verified=true&login=true`)\n\n    })\n  }).catch((err) => {\n    return next(err)\n  })\n})\n\nrouter.get('/error', (req, res, next) => {\n\n  res.render('error', {message: 'Noting to see here'})\n})\n\nmodule.exports = router\n"]}