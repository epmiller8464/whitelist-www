{"version":3,"sources":["../../routes/index.js"],"names":["express","require","router","Router","geoip","csurf","cookie","nets","Whitelist","moment","mail","get","req","res","next","contributionAmounts","loadContributionAmounts","render","title","site_key","process","env","RECAPTCHA_KEY","csrfToken","geo","lookup","query","ip","status","json","post","hasCookie","success","body","response","remoteip","email","error","validateSubmitter","err","result","record","cryptoType","purchaseAmount","save","doc","Date","now","httpOnly","maxAge","add","unix","signed","secure","NODE_ENV","path","to","name","split","then","catch","e","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","value","display","token","cookies","signedCookies","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["const express = require('express')\nconst router = express.Router()\nconst geoip = require('geoip-lite')\nconst csurf = require('csurf')({cookie: true})\nconst nets = require('nets')\nconst {Whitelist} = require('../lib/model')\nconst moment = require('moment')\nconst mail = require('../lib/mail')\n/* GET home page. */\nrouter.get('/', csurf, function (req, res, next) {\n  let contributionAmounts = loadContributionAmounts()\n  res.render('index', {\n    title: 'Swytch',\n    contributionAmounts: contributionAmounts,\n    site_key: process.env.RECAPTCHA_KEY,\n    csrfToken: req.csrfToken()\n  })\n})\nrouter.get('/geo-locate', (req, res, next) => {\n  let geo = geoip.lookup(req.query.ip)\n  return res.status(200).json(geo)\n})\n\nrouter.post('/whitelist', csurf, (req, res, next) => {\n\n  if (hasCookie(req)) {\n    return res.status(200).json({success: true})\n  }\n\n  let body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n  let email = req.body.email\n\n  if ((!body.response || !email)) {\n    return res.status(400).json({error: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, (err, result) => {\n    if (err || !result.success) {\n      return res.status(400).json({error: 'Validation failed.'})\n    }\n    // var data =\n    const record = new Whitelist({\n      email: req.body.email,\n      ip: req.ip,\n      cryptoType: req.body.cryptoType,\n      purchaseAmount: req.body.purchaseAmount\n    })\n    record.save((err, doc) => {\n      if (err) {\n        return res.status(400).json({error: 'Invalid parameters'})\n      }\n\n      res.cookie('_wl', Date.now(), {\n        httpOnly: true,\n        maxAge: moment().add(90, 'days').unix(),\n        signed: true,\n        secure: process.env.NODE_ENV !== 'development',\n        path: '/'\n      })\n      res.cookie('_wl_ip', req.ip, {\n        httpOnly: true,\n        maxAge: moment().add(90, 'days').unix(),\n        signed: true,\n        secure: process.env.NODE_ENV !== 'development',\n        path: '/'\n      })\n      mail({to: doc.email, name: doc.email.split('@')[0]})\n      .then((result) => {\n        return res.status(200).json({success: true})\n      }).catch((e) => {\n        return res.status(200).json({success: true})\n      })\n    })\n  })\n})\n\nrouter.get('/whitelist/confirm', (req, res, next) => {\n\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  let url = `https://www.google.com/recaptcha/api/siteverify?secret= ${process.env.RECAPTCHA_SECRET}&response=${recaptcha}&remoteip=${ip}`\n  let request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, (err, res, body) => {\n    return cb(err, JSON.parse(body))\n  })\n}\n\nfunction loadContributionAmounts () {\n  return [\n    {value: null, display: 'USD > 100'},\n    {value: '100-1000', display: 'USD 100 - 1,000'},\n    {value: '1000-5000', display: 'USD 1,000 - 5,000'},\n    {value: '5000-10000', display: 'USD 5,000 - 10,000'},\n    {value: '10000-50000', display: 'USD 10,000 - 50,000'},\n    {value: '50000-100000', display: 'USD 50,000 - 100,000'},\n    {value: '100000-MAX', display: 'USD +100,000'}\n  ]\n}\n\nfunction hasCookie (req) {\n  var token = null\n  if (req && req.cookies) {\n    token = req.cookies['_wl']\n    if (!token) {\n      token = req.signedCookies['_wl']\n    }\n  }\n  return token\n}\n\nmodule.exports = router\n"]}