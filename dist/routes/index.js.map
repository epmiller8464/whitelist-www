{"version":3,"sources":["../../routes/index.js"],"names":["express","require","router","Router","authenticate","check","validationResult","query","matchedData","sanitize","sanitizeQuery","Subscriber","User","Email","verifyToken","validate","isEmail","withMessage","trim","normalizeEmail","get","req","res","next","render","title","VIDEO_URL","process","env","SWYTCH_VIDEO_URL","WP_URL","WHITEPAPER_URL","csrfToken","logOut","user","session","locals","clearCookie","hideLogin","post","redirect","token","then","result","findOneAndUpdate","_id","sub","verified","err","Error","catch","message","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\nconst authenticate = require('../lib/authenticate')\nconst {check, validationResult, query} = require('express-validator/check')\nconst {matchedData, sanitize, sanitizeQuery} = require('express-validator/filter')\nconst {Subscriber, User} = require('../lib/model')\nconst {Email} = require('../lib/mail')\nconst {verifyToken} = require('../lib/jsonwebtoken')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim()]\n\nrouter.get('/', function (req, res, next) {\n  res.render('index', {\n    title: 'Swytch',\n    VIDEO_URL: process.env.SWYTCH_VIDEO_URL,\n    WP_URL: process.env.WHITEPAPER_URL,\n    csrfToken: req.csrfToken()\n  })\n})\nrouter.get('/login', function (req, res, next) {\n  req.logOut()\n  req.user = null\n  req.session = null\n  res.locals = null\n  res.clearCookie('SU_USER')\n  res.render('login', {\n    title: 'Swytch',\n    hideLogin: true,\n    csrfToken: req.csrfToken()\n  })\n})\n\nrouter.post('/logout', function (req, res, next) {\n  req.logOut()\n  req.user = null\n  req.session = null\n  res.locals = null\n  res.clearCookie('SU_USER')\n  res.redirect('/')\n})\n\nrouter.get('/verify/:id', function (req, res, next) {\n  var token = req.query.token\n\n  verifyToken(token)\n  .then((result) => {\n    // TODO: blacklist the token\n    User.findOneAndUpdate({_id: result.sub}, {verified: true}, function (err, user) {\n      if (err || !user) {\n        return next(new Error('We couldn\\'t process your request at this time.'))\n      }\n\n      if (user) {\n        res.redirect('/platform/token-sale')\n      }\n    })\n  }).catch((err) => {\n    return next(err)\n  })\n})\n\nrouter.get('/error', (req, res, next) => {\n  res.render('error', {message: 'Noting to see here'})\n})\n\nmodule.exports = router\n"]}