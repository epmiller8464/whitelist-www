{"version":3,"sources":["../../routes/marketing.js"],"names":["express","require","router","Router","check","validationResult","query","matchedData","sanitize","sanitizeQuery","Subscriber","Email","validate","isEmail","withMessage","trim","normalizeEmail","post","req","res","next","errors","isEmpty","status","json","mapped","create","email","body","subscribeTo","err","doc","success","message","sendNewsletterWelcomeEmail","to","then","result","catch","module","exports"],"mappings":"AAAA;;AACA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,SAASF,QAAQG,MAAR,EAAf;;eACyCF,QAAQ,yBAAR,C;IAAlCG,K,YAAAA,K;IAAOC,gB,YAAAA,gB;IAAkBC,K,YAAAA,K;;gBACeL,QAAQ,0BAAR,C;IAAxCM,W,aAAAA,W;IAAaC,Q,aAAAA,Q;IAAUC,a,aAAAA,a;;gBACTR,QAAQ,cAAR,C;IAAdS,U,aAAAA,U;;gBACST,QAAQ,aAAR,C;IAATU,K,aAAAA,K;AACP;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,IAAMC,WAAW,CAACR,MAAM,OAAN,EAAeS,OAAf,GAAyBC,WAAzB,CAAqC,kBAArC,EAAyDC,IAAzD,GAAgEC,cAAhE,EAAD,EAAmFR,SAAS,OAAT,EAAkBO,IAAlB,GAAyBC,cAAzB,EAAnF,CAAjB;;AAEAd,OAAOe,IAAP,CAAY,kBAAZ,EAAgCL,QAAhC,EAA0C,UAAUM,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AAClE,MAAMC,SAAShB,iBAAiBa,GAAjB,CAAf;AACA,MAAI,CAACG,OAAOC,OAAP,EAAL,EAAuB;AACrB,WAAOH,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACH,QAAQA,OAAOI,MAAP,EAAT,EAArB,CAAP;AAED;AACDf,aAAWgB,MAAX,CAAkB,EAACC,OAAOT,IAAIU,IAAJ,CAASD,KAAjB,EAAwBE,aAAa,CAAC,aAAD,CAArC,EAAlB,EAAyE,UAACC,GAAD,EAAMC,GAAN,EAAc;AACrF,QAAID,GAAJ,EAAS;AACP,aAAOX,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACQ,SAAS,KAAV,EAAiBC,SAAS,oCAA1B,EAArB,CAAP;AACD;AACDtB,UAAMuB,0BAAN,CAAiC,EAACC,IAAIjB,IAAIU,IAAJ,CAASD,KAAd,EAAjC,EACCS,IADD,CACM,UAACC,MAAD,EAAY;AAChBlB,UAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACQ,SAAS,IAAV,EAArB;AACD,KAHD,EAGGM,KAHH,CAGS,UAACR,GAAD,EAAS;AAChB;AACAX,UAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACQ,SAAS,KAAV,EAArB;AACD,KAND;AAOD,GAXD;AAYD,CAlBD;;AAoBAO,OAAOC,OAAP,GAAiBtC,MAAjB","file":"marketing.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\nconst {check, validationResult, query} = require('express-validator/check')\nconst {matchedData, sanitize, sanitizeQuery} = require('express-validator/filter')\nconst {Subscriber} = require('../lib/model')\nconst {Email} = require('../lib/mail')\n/* GET home page. */\n// router.get('/', function (req, res, next) {\n//   res.render('index', {\n//     title: 'Swytch',\n//     site_key: process.env.RECAPTCHA_KEY,\n//     VIDEO_URL: process.env.SWYTCH_VIDEO_URL,\n//     WP_URL: process.env.WHITEPAPER_URL,\n//     csrfToken: req.csrfToken()\n//   })\n// })\n\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim().normalizeEmail()]\n\nrouter.post('/newsletter/join', validate, function (req, res, next) {\n  const errors = validationResult(req)\n  if (!errors.isEmpty()) {\n    return res.status(422).json({errors: errors.mapped()})\n\n  }\n  Subscriber.create({email: req.body.email, subscribeTo: ['news-letter']}, (err, doc) => {\n    if (err) {\n      return res.status(200).json({success: false, message: 'Your e-mail is already subscribed.'})\n    }\n    Email.sendNewsletterWelcomeEmail({to: req.body.email})\n    .then((result) => {\n      res.status(200).json({success: true})\n    }).catch((err) => {\n      // req.log(err)\n      res.status(200).json({success: false})\n    })\n  })\n})\n\nmodule.exports = router"]}