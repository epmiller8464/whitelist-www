{"version":3,"sources":["../../../routes/api/user.js"],"names":["express","require","router","Router","check","validationResult","query","matchedData","sanitize","sanitizeQuery","User","Email","confirmEmailToken","verifyToken","validate","isEmail","withMessage","trim","normalizeEmail","post","req","res","next","errors","isEmpty","status","json","mapped","user","body","save","err","doc","success","message","id","then","token","sendConfirmation","to","email","name","first_name","last_name","result","data","toObject","catch","error","module","exports"],"mappings":"AAAA;;AACA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,SAASF,QAAQG,MAAR,EAAf;;eACyCF,QAAQ,yBAAR,C;IAAlCG,K,YAAAA,K;IAAOC,gB,YAAAA,gB;IAAkBC,K,YAAAA,K;;gBACeL,QAAQ,0BAAR,C;IAAxCM,W,aAAAA,W;IAAaC,Q,aAAAA,Q;IAAUC,a,aAAAA,a;;gBACfR,QAAQ,iBAAR,C;IAARS,I,aAAAA,I;;gBACST,QAAQ,gBAAR,C;IAATU,K,aAAAA,K;;gBACkCV,QAAQ,wBAAR,C;IAAlCW,iB,aAAAA,iB;IAAmBC,W,aAAAA,W;;AAC1B,IAAMC,WAAW,CAACV,MAAM,OAAN,EAAeW,OAAf,GAAyBC,WAAzB,CAAqC,kBAArC,EAAyDC,IAAzD,GAAgEC,cAAhE,EAAD,EAAmFV,SAAS,OAAT,EAAkBS,IAAlB,EAAnF,CAAjB;;AAEAf,OAAOiB,IAAP,CAAY,GAAZ,EAAiBL,QAAjB,EAA2B,UAAUM,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AACnD,MAAMC,SAASlB,iBAAiBe,GAAjB,CAAf;AACA,MAAI,CAACG,OAAOC,OAAP,EAAL,EAAuB;AACrB,WAAOH,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACH,QAAQA,OAAOI,MAAP,EAAT,EAArB,CAAP;AACD;;AAED,MAAIC,OAAO,IAAIlB,IAAJ,CAASU,IAAIS,IAAb,CAAX;;AAEAD,OAAKE,IAAL,CAAU,UAACC,GAAD,EAAMC,GAAN,EAAc;AACtB,QAAID,GAAJ,EAAS;AACP,aAAOV,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACO,SAAS,KAAV,EAAiBC,SAAS,oCAA1B,EAArB,CAAP;AACD;AACDtB,sBAAkBoB,IAAIG,EAAtB,EACCC,IADD,CACM,UAACC,KAAD,EAAW;;AAEf1B,YAAM2B,gBAAN,CAAuB,EAACH,IAAIH,IAAIG,EAAT,EAAaI,IAAInB,IAAIS,IAAJ,CAASW,KAA1B,EAAiCC,MAAST,IAAIU,UAAb,SAA2BV,IAAIW,SAAhE,EAA6EN,OAAOA,KAApF,EAAvB,EACCD,IADD,CACM,UAACQ,MAAD,EAAY;AAChB,eAAOvB,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACO,SAAS,IAAV,EAAgBY,MAAMb,IAAIc,QAAJ,EAAtB,EAArB,CAAP;AAED,OAJD,EAIGC,KAJH,CAIS,UAAChB,GAAD,EAAS;AAChB,cAAMA,GAAN;AACD,OAND;AAOD,KAVD,EAUGgB,KAVH,CAUS,UAAChB,GAAD,EAAS;AAChB,aAAOV,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACsB,OAAO,IAAR,EAAcd,SAASH,IAAIG,OAA3B,EAArB,CAAP;AACD,KAZD;AAaD,GAjBD;AAkBD,CA1BD;;AA4BAe,OAAOC,OAAP,GAAiBhD,MAAjB","file":"user.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\nconst {check, validationResult, query} = require('express-validator/check')\nconst {matchedData, sanitize, sanitizeQuery} = require('express-validator/filter')\nconst {User} = require('../../lib/model')\nconst {Email} = require('../../lib/mail')\nconst {confirmEmailToken, verifyToken} = require('../../lib/jsonwebtoken')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim()]\n\nrouter.post('/', validate, function (req, res, next) {\n  const errors = validationResult(req)\n  if (!errors.isEmpty()) {\n    return res.status(422).json({errors: errors.mapped()})\n  }\n\n  var user = new User(req.body)\n\n  user.save((err, doc) => {\n    if (err) {\n      return res.status(200).json({success: false, message: 'Your e-mail is already subscribed.'})\n    }\n    confirmEmailToken(doc.id)\n    .then((token) => {\n\n      Email.sendConfirmation({id: doc.id, to: req.body.email, name: `${doc.first_name} ${doc.last_name}`, token: token})\n      .then((result) => {\n        return res.status(200).json({success: true, data: doc.toObject()})\n\n      }).catch((err) => {\n        throw err\n      })\n    }).catch((err) => {\n      return res.status(400).json({error: true, message: err.message})\n    })\n  })\n})\n\nmodule.exports = router\n"]}