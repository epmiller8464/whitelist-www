{"version":3,"sources":["../../../routes/api/user.js"],"names":["express","require","router","Router","check","validationResult","sanitize","User","Email","confirmEmailToken","validate","isEmail","withMessage","trim","normalizeEmail","isAlphanumeric","post","req","res","next","errors","isEmpty","status","json","mapped","user","body","save","err","doc","success","message","id","then","token","sendConfirmation","to","email","name","first_name","last_name","result","data","toObject","catch","error","module","exports"],"mappings":"AAAA;;AACA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,SAASF,QAAQG,MAAR,EAAf;;eACkCF,QAAQ,yBAAR,C;IAA3BG,K,YAAAA,K;IAAOC,gB,YAAAA,gB;;gBACKJ,QAAQ,0BAAR,C;IAAZK,Q,aAAAA,Q;;gBACQL,QAAQ,iBAAR,C;IAARM,I,aAAAA,I;;gBACSN,QAAQ,gBAAR,C;IAATO,K,aAAAA,K;;gBACqBP,QAAQ,wBAAR,C;IAArBQ,iB,aAAAA,iB;;AACP,IAAMC,WAAW,CAACN,MAAM,OAAN,EAAeO,OAAf,GAAyBC,WAAzB,CAAqC,kBAArC,EAAyDC,IAAzD,GAAgEC,cAAhE,EAAD,EAAmFV,MAAM,YAAN,EAAoBW,cAApB,GAAqCF,IAArC,EAAnF,EAAgIT,MAAM,WAAN,EAAmBW,cAAnB,GAAoCF,IAApC,EAAhI,EAA4KP,SAAS,OAAT,EAAkBO,IAAlB,EAA5K,EAAsMP,SAAS,YAAT,EAAuBO,IAAvB,EAAtM,EAAqOP,SAAS,WAAT,EAAsBO,IAAtB,EAArO,CAAjB;;AAEAX,OAAOc,IAAP,CAAY,GAAZ,EAAiBN,QAAjB,EAA2B,UAAUO,GAAV,EAAeC,GAAf,EAAoBC,IAApB,EAA0B;AACnD,MAAMC,SAASf,iBAAiBY,GAAjB,CAAf;AACA,MAAI,CAACG,OAAOC,OAAP,EAAL,EAAuB;AACrB,WAAOH,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACH,QAAQA,OAAOI,MAAP,EAAT,EAArB,CAAP;AACD;;AAED,MAAIC,OAAO,IAAIlB,IAAJ,CAASU,IAAIS,IAAb,CAAX;;AAEAD,OAAKE,IAAL,CAAU,UAACC,GAAD,EAAMC,GAAN,EAAc;AACtB,QAAID,GAAJ,EAAS;AACP,aAAOV,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACO,SAAS,KAAV,EAAiBC,SAAS,oCAA1B,EAArB,CAAP;AACD;AACDtB,sBAAkBoB,IAAIG,EAAtB,EAA0BC,IAA1B,CAA+B,UAACC,KAAD,EAAW;AACxC1B,YAAM2B,gBAAN,CAAuB,EAACH,IAAIH,IAAIG,EAAT,EAAaI,IAAInB,IAAIS,IAAJ,CAASW,KAA1B,EAAiCC,MAAST,IAAIU,UAAb,SAA2BV,IAAIW,SAAhE,EAA6EN,OAAOA,KAApF,EAAvB,EACCD,IADD,CACM,UAACQ,MAAD,EAAY;AAChB,eAAOvB,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACO,SAAS,IAAV,EAAgBY,MAAMb,IAAIc,QAAJ,EAAtB,EAArB,CAAP;AAED,OAJD,EAIGC,KAJH,CAIS,UAAChB,GAAD,EAAS;AAChB,cAAMA,GAAN;AACD,OAND;AAOD,KARD,EAQGgB,KARH,CAQS,UAAChB,GAAD,EAAS;AAChB,aAAOV,IAAII,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqB,EAACsB,OAAO,IAAR,EAAcd,SAASH,IAAIG,OAA3B,EAArB,CAAP;AACD,KAVD;AAWD,GAfD;AAgBD,CAxBD;;AA0BAe,OAAOC,OAAP,GAAiB7C,MAAjB","file":"user.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\nconst {check, validationResult} = require('express-validator/check')\nconst {sanitize} = require('express-validator/filter')\nconst {User} = require('../../lib/model')\nconst {Email} = require('../../lib/mail')\nconst {confirmEmailToken} = require('../../lib/jsonwebtoken')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), check('first_name').isAlphanumeric().trim(), check('last_name').isAlphanumeric().trim(), sanitize('email').trim(), sanitize('first_name').trim(), sanitize('last_name').trim()]\n\nrouter.post('/', validate, function (req, res, next) {\n  const errors = validationResult(req)\n  if (!errors.isEmpty()) {\n    return res.status(422).json({errors: errors.mapped()})\n  }\n\n  var user = new User(req.body)\n\n  user.save((err, doc) => {\n    if (err) {\n      return res.status(200).json({success: false, message: 'Your e-mail is already subscribed.'})\n    }\n    confirmEmailToken(doc.id).then((token) => {\n      Email.sendConfirmation({id: doc.id, to: req.body.email, name: `${doc.first_name} ${doc.last_name}`, token: token})\n      .then((result) => {\n        return res.status(200).json({success: true, data: doc.toObject()})\n\n      }).catch((err) => {\n        throw err\n      })\n    }).catch((err) => {\n      return res.status(400).json({error: true, message: err.message})\n    })\n  })\n})\n\nmodule.exports = router\n"]}