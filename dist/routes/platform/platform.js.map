{"version":3,"sources":["../../../routes/platform/platform.js"],"names":["express","require","router","Router","geoip","nets","moment","mail","notifier","get","csurf","req","res","next","contributionAmounts","loadContributionAmounts","render","title","site_key","process","env","RECAPTCHA_KEY","csrfToken","geo","lookup","query","ip","status","json","post","hasCookie","success","body","response","remoteip","email","error","validateSubmitter","err","result","cookie","Date","now","httpOnly","maxAge","add","unix","signed","secure","NODE_ENV","path","cryptoType","purchaseAmount","timeZone","ts","zoneName","offset","usCitizenAttestation","canParticipate","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","value","display","token","cookies","signedCookies","module","exports"],"mappings":"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","file":"platform.js","sourcesContent":["const express = require('express')\nconst router = express.Router()\nconst geoip = require('geoip-lite')\nconst nets = require('nets')\nconst moment = require('moment')\nconst mail = require('../lib/mail')\nconst {notifier} = require('../lib/notifier')\n\n/* GET home page. */\nrouter.get('/', csurf, function (req, res, next) {\n  let contributionAmounts = loadContributionAmounts()\n  res.render('index', {\n    title: 'Swytch',\n    contributionAmounts: contributionAmounts,\n    site_key: process.env.RECAPTCHA_KEY,\n    csrfToken: req.csrfToken()\n  })\n})\nrouter.get('/geo-locate', (req, res, next) => {\n  let geo = geoip.lookup(req.query.ip)\n  return res.status(200).json(geo)\n})\n\nrouter.post('/whitelist', csurf, (req, res, next) => {\n\n  if (hasCookie(req)) {\n    return res.status(200).json({success: true})\n  }\n\n  let body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n  let email = req.body.email\n\n  if ((!body.response || !email)) {\n    return res.status(400).json({error: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, (err, result) => {\n    if (err || !result.success) {\n      return res.status(400).json({error: 'Validation failed.'})\n    }\n\n    res.cookie('_wl', Date.now(), {\n      httpOnly: true,\n      maxAge: moment().add(90, 'days').unix(),\n      signed: true,\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/'\n    })\n    res.cookie('_wl_ip', req.ip, {\n      httpOnly: true,\n      maxAge: moment().add(90, 'days').unix(),\n      signed: true,\n      secure: process.env.NODE_ENV !== 'development',\n      path: '/'\n    })\n    notifier('onboard', {\n      email: req.body.email,\n      ip: req.ip,\n      cryptoType: req.body.cryptoType,\n      purchaseAmount: req.body.purchaseAmount,\n      timeZone: {\n        ts: req.body.timeZone.ts,\n        zoneName: req.body.timeZone.zoneName,\n        offset: req.body.timeZone.offset\n      },\n      usCitizenAttestation: req.body.usCitizenAttestation,\n      canParticipate: !req.body.usCitizenAttestation\n    })\n    return res.status(200).json({success: true})\n    // })\n  })\n})\n\nrouter.get('/whitelist/confirmation', (req, res, next) => {\n\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  let url = `https://www.google.com/recaptcha/api/siteverify?secret= ${process.env.RECAPTCHA_SECRET}&response=${recaptcha}&remoteip=${ip}`\n  let request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, (err, res, body) => {\n    return cb(err, JSON.parse(body))\n  })\n}\n\nfunction loadContributionAmounts () {\n  return [\n    {value: null, display: 'USD > 100'},\n    {value: '100-1000', display: 'USD 100 - 1,000'},\n    {value: '1000-5000', display: 'USD 1,000 - 5,000'},\n    {value: '5000-10000', display: 'USD 5,000 - 10,000'},\n    {value: '10000-50000', display: 'USD 10,000 - 50,000'},\n    {value: '50000-100000', display: 'USD 50,000 - 100,000'},\n    {value: '100000-MAX', display: 'USD +100,000'}\n  ]\n}\n\nfunction hasCookie (req) {\n  var token = null\n  if (req && req.cookies) {\n    token = req.cookies['_wl']\n    if (!token) {\n      token = req.signedCookies['_wl']\n    }\n  }\n  return token\n}\n\nmodule.exports = router\n"]}