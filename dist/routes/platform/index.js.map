{"version":3,"sources":["../../../routes/platform/index.js"],"names":["express","require","router","Router","check","sanitize","validate","isEmail","withMessage","trim","normalizeEmail","nets","notifier","confirmEmailToken","verifyToken","Email","Whitelist","User","get","req","res","next","redirect","step","user","verified","whitelisted","countries","first_name","last_name","email","id","_id","render","title","contributionAmounts","loadContributionAmounts","site_key","process","env","RECAPTCHA_KEY","csrfToken","post","body","response","remoteip","ip","status","json","error","message","validateSubmitter","err","result","success","whitelist","country_code","crypto_type","purchase_amount","timezone","us_citizen","can_participate","owner_id","save","findOneAndUpdate","new","doc","session","me","toObject","query","toString","Error","then","token","sendConfirmation","to","name","catch","e","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","value","display","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\n// const authenticate = require('../../lib/authenticate')\nconst {check} = require('express-validator/check')\nconst {sanitize} = require('express-validator/filter')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim()]\nconst nets = require('nets')\nconst notifier = require('../../lib/notifier')\nconst {confirmEmailToken, verifyToken} = require('../../lib/jsonwebtoken')\nconst {Email} = require('../../lib/mail')\n\nconst {Whitelist, User} = require('../../lib/model/index')\n\nrouter.get('/', function (req, res, next) {\n  return res.redirect('/platform/token-sale')\n})\n\nrouter.get('/token-sale', function (req, res, next) {\n\n  let step = 'verify-email'\n  if (req.user.verified) {\n    step = 'whitelist'\n  }\n  if (req.user.verified && req.user.whitelisted) {\n    step = 'complete'\n  }\n\n  let countries = require('../../lib/countries')()\n  let user = {\n    first_name: req.user.first_name,\n    last_name: req.user.last_name,\n    email: req.user.email,\n    verified: req.user.verified,\n    whitelisted: req.user.whitelisted,\n    id: req.user._id\n  }\n  res.render('platform/token_sale', {\n    title: 'Swytch Pre-Sale Whitelist Registration',\n    user: user,\n    countries: countries,\n    step: step,\n    contributionAmounts: loadContributionAmounts(),\n    site_key: process.env.RECAPTCHA_KEY,\n    csrfToken: req.csrfToken()\n  })\n})\nrouter.post('/token-sale', function (req, res, next) {\n\n  var body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n\n  if (!body.response) {\n    return res.status(400).json({error: true, message: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, function (err, result) {\n    if (err || !result.success) {\n      return res.status(400).json({error: true, message: 'Validation failed.'})\n    }\n    let whitelist = new Whitelist({\n      ip: req.ip,\n      country_code: req.body.country_code,\n      crypto_type: req.body.crypto_type,\n      purchase_amount: req.body.purchase_amount,\n      timezone: req.body.timezone,\n      us_citizen: req.body.us_citizen,\n      can_participate: !req.body.us_citizen,\n      owner_id: req.user._id,\n      verified: true\n    })\n    whitelist.save((err) => {\n\n      User.findOneAndUpdate({_id: req.user._id}, {whitelisted: true}, {new: true}, (error, doc) => {\n\n        req.user = req.session.me = doc.toObject()\n        return res.status(200).json({success: true})\n      })\n    })\n  })\n})\nrouter.get('/resend/verify-email', (req, res, next) => {\n\n  let id = req.query.id\n\n  if (id !== req.user._id.toString()) {\n    return next(new Error('Unauthorized'))\n  }\n\n  confirmEmailToken(id)\n  .then((token) => {\n    Email.sendConfirmation({\n      id: id,\n      to: req.user.email,\n      name: `${req.user.first_name} ${req.user.last_name}`,\n      token: token\n    })\n    .then((result) => {\n\n      res.redirect('/platform/token-sale')\n    }).catch((e) => {\n      return next(new Error('We couldn\\'t process your request at this time.'))\n    })\n  }).catch((err) => {\n    return next(new Error('We couldn\\'t process your request at this time.'))\n  })\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  var url = 'https://www.google.com/recaptcha/api/siteverify?secret= ' + process.env.RECAPTCHA_SECRET + '&response=' + recaptcha + '&remoteip=' + ip\n  var request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, function (err, res, body) {\n    return cb(err, JSON.parse(body))\n  })\n}\n\nfunction loadContributionAmounts () {\n  return [\n    {value: '0-100', display: 'USD > 100'},\n    {value: '100-1000', display: 'USD 100 - 1,000'},\n    {value: '1000-5000', display: 'USD 1,000 - 5,000'},\n    {value: '5000-10000', display: 'USD 5,000 - 10,000'},\n    {value: '10000-50000', display: 'USD 10,000 - 50,000'},\n    {value: '50000-100000', display: 'USD 50,000 - 100,000'},\n    {value: '100000-MAX', display: 'USD +100,000'}\n  ]\n}\n\nmodule.exports = router\n"]}