{"version":3,"sources":["../../../routes/platform/index.js"],"names":["express","require","router","Router","authenticate","check","sanitize","validate","isEmail","withMessage","trim","normalizeEmail","nets","notifier","confirmEmailToken","verifyToken","Email","get","req","res","next","redirect","step","user","verified","whitelisted","countries","first_name","last_name","email","id","_id","render","title","contributionAmounts","loadContributionAmounts","site_key","process","env","RECAPTCHA_KEY","csrfToken","message","query","toString","Error","then","token","sendConfirmation","to","name","result","catch","e","err","post","body","response","remoteip","ip","status","json","error","validateSubmitter","success","cryptoType","purchaseAmount","timeZone","ts","zoneName","offset","usCitizenAttestation","canParticipate","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","value","display","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\nconst authenticate = require('../../lib/authenticate')\nconst {check} = require('express-validator/check')\nconst {sanitize} = require('express-validator/filter')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim()]\nconst nets = require('nets')\nconst notifier = require('../../lib/notifier')\nconst {confirmEmailToken, verifyToken} = require('../../lib/jsonwebtoken')\nconst {Email} = require('../../lib/mail')\n\nrouter.get('/', function (req, res, next) {\n  // if (!req.user.verified) {\n  return res.redirect('/platform/token-sale')\n  // }\n  // res.render('platform', {title: 'Swytch Platform', csrfToken: req.csrfToken()})\n})\n\nrouter.get('/token-sale', function (req, res, next) {\n\n  let step = 'verify-email'\n  if (req.user.verified && !req.user.whitelisted) {\n    step = 'whitelist'\n  } else if (req.user.verified && req.user.whitelisted) {\n    step = 'complete'\n  }\n\n  let countries = require('../../lib/countries')()\n  let user = {\n    first_name: req.user.first_name,\n    last_name: req.user.last_name,\n    email: req.user.email,\n    verified: req.user.verified,\n    whitelisted: req.user.whitelisted,\n    id: req.user._id\n  }\n  res.render('platform/token_sale', {\n    title: 'Swytch Pre-Sale Whitelist Registration',\n    user: user,\n    countries: countries,\n    step: step,\n    contributionAmounts: loadContributionAmounts(),\n    site_key: process.env.RECAPTCHA_KEY,\n    csrfToken: req.csrfToken()\n  })\n})\n\nrouter.get('/error', (req, res, next) => {\n  res.render('error', {message: 'Opps we\\'ll fix that...'})\n})\n\nrouter.get('/resend/verify-email', (req, res, next) => {\n\n  let id = req.query.id\n\n  if (id !== req.user._id.toString()) {\n    return next(new Error('Unauthorized'))\n  }\n\n  confirmEmailToken(id)\n  .then((token) => {\n    Email.sendConfirmation({\n      id: id,\n      to: req.user.email,\n      name: `${req.user.first_name} ${req.user.last_name}`,\n      token: token\n    })\n    .then((result) => {\n\n      res.redirect('/platform/token-sale')\n    }).catch((e) => {\n      return next(new Error('We couldn\\'t process your request at this time.'))\n    })\n  }).catch((err) => {\n    return next(new Error('We couldn\\'t process your request at this time.'))\n  })\n})\n\nrouter.post('/whitelist', function (req, res, next) {\n\n  var body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n  var email = req.body.email\n\n  if (!body.response || !email) {\n    return res.status(400).json({error: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, function (err, result) {\n    if (err || !result.success) {\n      return res.status(400).json({error: 'Validation failed.'})\n    }\n\n    notifier('whitelist', {\n      email: req.body.email,\n      first_name: req.body.first_name,\n      last_name: req.body.last_name,\n      ip: req.ip,\n      cryptoType: req.body.cryptoType,\n      purchaseAmount: req.body.purchaseAmount,\n      timeZone: {\n        ts: req.body.timeZone.ts,\n        zoneName: req.body.timeZone.zoneName,\n        offset: req.body.timeZone.offset\n      },\n      usCitizenAttestation: req.body.usCitizenAttestation,\n      canParticipate: !req.body.usCitizenAttestation\n    })\n    return res.status(200).json({success: true})\n  })\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  var url = 'https://www.google.com/recaptcha/api/siteverify?secret= ' + process.env.RECAPTCHA_SECRET + '&response=' + recaptcha + '&remoteip=' + ip\n  var request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, function (err, res, body) {\n    return cb(err, JSON.parse(body))\n  })\n}\n\nfunction loadContributionAmounts () {\n  return [{value: null, display: 'USD > 100'}, {value: '100-1000', display: 'USD 100 - 1,000'}, {\n    value: '1000-5000',\n    display: 'USD 1,000 - 5,000'\n  }, {value: '5000-10000', display: 'USD 5,000 - 10,000'}, {\n    value: '10000-50000',\n    display: 'USD 10,000 - 50,000'\n  }, {value: '50000-100000', display: 'USD 50,000 - 100,000'}, {value: '100000-MAX', display: 'USD +100,000'}]\n}\n\nmodule.exports = router\n"]}