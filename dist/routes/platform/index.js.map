{"version":3,"sources":["../../../routes/platform/index.js"],"names":["express","require","router","Router","check","sanitize","validate","isEmail","withMessage","trim","normalizeEmail","nets","notifier","confirmEmailToken","verifyToken","Email","Whitelist","User","get","req","res","next","redirect","findById","user","_id","err","step","verified","whitelisted","countries","data","first_name","last_name","email","id","render","title","contributionAmounts","loadContributionAmounts","site_key","process","env","RECAPTCHA_KEY","csrfToken","post","body","response","remoteip","ip","status","json","error","message","validateSubmitter","result","success","whitelist","country_code","crypto_type","purchase_amount","timezone","us_citizen","can_participate","owner_id","save","findOneAndUpdate","new","doc","query","toString","Error","then","token","sendConfirmation","to","name","catch","e","recaptcha","cb","url","RECAPTCHA_SECRET","request","method","encoding","undefined","JSON","parse","value","display","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["'use strict'\nconst express = require('express')\nconst router = express.Router()\n// const authenticate = require('../../lib/authenticate')\nconst {check} = require('express-validator/check')\nconst {sanitize} = require('express-validator/filter')\nconst validate = [check('email').isEmail().withMessage('must be an email').trim().normalizeEmail(), sanitize('email').trim()]\nconst nets = require('nets')\nconst notifier = require('../../lib/notifier')\nconst {confirmEmailToken, verifyToken} = require('../../lib/jsonwebtoken')\nconst {Email} = require('../../lib/mail')\n\nconst {Whitelist, User} = require('../../lib/model/index')\n\nrouter.get('/', function (req, res, next) {\n  return res.redirect('/platform/token-sale')\n})\n\nrouter.get('/token-sale', function (req, res, next) {\n\n  User.findById(req.user._id, (err, user) => {\n\n    let step = 'verify-email'\n    if (user.verified) {\n      step = 'whitelist'\n    }\n    if (user.verified && user.whitelisted) {\n      step = 'complete'\n    }\n\n    let countries = require('../../lib/countries')()\n    let data = {\n      first_name: user.first_name,\n      last_name: user.last_name,\n      email: user.email,\n      verified: user.verified,\n      whitelisted: user.whitelisted,\n      id: user._id\n    }\n    res.render('platform/token_sale', {\n      title: 'Swytch Pre-Sale Whitelist Registration',\n      user: data,\n      countries: countries,\n      step: step,\n      contributionAmounts: loadContributionAmounts(),\n      site_key: process.env.RECAPTCHA_KEY,\n      csrfToken: req.csrfToken()\n    })\n  })\n})\n\nrouter.post('/token-sale', function (req, res, next) {\n\n  var body = {response: req.body['g-recaptcha-response'], remoteip: req.ip}\n\n  if (!body.response) {\n    return res.status(400).json({error: true, message: 'Invalid parameters'})\n  }\n\n  validateSubmitter(body.response, body.remoteip, function (err, result) {\n    if (err || !result.success) {\n      return res.status(400).json({error: true, message: 'Validation failed.'})\n    }\n    let whitelist = new Whitelist({\n      ip: req.ip,\n      country_code: req.body.country_code,\n      crypto_type: req.body.crypto_type,\n      purchase_amount: req.body.purchase_amount,\n      timezone: req.body.timezone,\n      us_citizen: req.body.us_citizen,\n      can_participate: !req.body.us_citizen,\n      owner_id: req.user._id,\n      verified: true\n    })\n    whitelist.save((err) => {\n\n      User.findOneAndUpdate({_id: req.user._id}, {whitelisted: true}, {new: true}, (error, doc) => {\n\n        // req.user = req.session.me = doc.toObject()\n        return res.status(200).json({success: true})\n      })\n    })\n  })\n})\nrouter.get('/resend/verify-email', (req, res, next) => {\n\n  let id = req.query.id\n\n  if (id !== req.user._id.toString()) {\n    return next(new Error('Unauthorized'))\n  }\n\n  confirmEmailToken(id)\n  .then((token) => {\n    Email.sendConfirmation({\n      id: id,\n      to: req.user.email,\n      name: `${req.user.first_name} ${req.user.last_name}`,\n      token: token\n    })\n    .then((result) => {\n\n      res.redirect('/platform/token-sale')\n    }).catch((e) => {\n      return next(new Error('We couldn\\'t process your request at this time.'))\n    })\n  }).catch((err) => {\n    return next(new Error('We couldn\\'t process your request at this time.'))\n  })\n})\n\nfunction validateSubmitter (recaptcha, ip, cb) {\n  var url = 'https://www.google.com/recaptcha/api/siteverify?secret= ' + process.env.RECAPTCHA_SECRET + '&response=' + recaptcha + '&remoteip=' + ip\n  var request = {\n    url: url,\n    method: 'POST',\n    encoding: undefined\n  }\n  nets(request, function (err, res, body) {\n    return cb(err, JSON.parse(body))\n  })\n}\n\nfunction loadContributionAmounts () {\n  return [\n    {value: '0-100', display: 'USD > 100'},\n    {value: '100-1000', display: 'USD 100 - 1,000'},\n    {value: '1000-5000', display: 'USD 1,000 - 5,000'},\n    {value: '5000-10000', display: 'USD 5,000 - 10,000'},\n    {value: '10000-50000', display: 'USD 10,000 - 50,000'},\n    {value: '50000-100000', display: 'USD 50,000 - 100,000'},\n    {value: '100000-MAX', display: 'USD +100,000'}\n  ]\n}\n\nmodule.exports = router\n"]}