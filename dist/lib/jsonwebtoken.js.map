{"version":3,"sources":["../../lib/jsonwebtoken.js"],"names":["uuid","require","jwt","moment","nonce","crypto","fs","TOKEN_TYPES","VERIFY_EMAIL_TOKEN","AUTH_TOKEN","confirmEmailToken","id","Promise","resolve","reject","jwtid","v4","payload","sub","type","tgeDate","process","env","TGE_DATE","TGE_DATE_FORMAT","daysUntilTGE","diff","format","expiresId","jwtOpts","expiresIn","issuer","ADMIN_EMAIL","sign","PK","e","accessToken","pk","Buffer","from","KEY","console","warn","readFileSync","PWD","algorithm","toString","verifyAccessToken","token","verify","maxAge","algorithms","tokenError","payLoad","refreshToken","verifyToken","generateAccessToken","req","res","next","session","user","_id","CS","module","exports"],"mappings":"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","file":"jsonwebtoken.js","sourcesContent":["'use strict'\nconst uuid = require('uuid')\nconst jwt = require('jsonwebtoken')\nconst moment = require('moment')\nconst nonce = require('nonce')()\nconst crypto = require('crypto')\nconst fs = require('fs')\nconst TOKEN_TYPES = {\n  VERIFY_EMAIL_TOKEN: 'verify_email_token',\n  AUTH_TOKEN: 'auth_token'\n}\n/**\n * @name confirmEmailToken\n * @param id {String} id of the subject\n * @returns {Promise}\n */\nconst confirmEmailToken = function (id) {\n  return new Promise(function (resolve, reject) {\n    try {\n      let jwtid = uuid.v4()\n\n      let payload = {\n        sub: id,\n        type: TOKEN_TYPES.VERIFY_EMAIL_TOKEN,\n        nonce: nonce()\n      }\n      let tgeDate = moment(process.env.TGE_DATE, process.env.TGE_DATE_FORMAT)\n      let daysUntilTGE = tgeDate.diff(moment({}).format(process.env.TGE_DATE_FORMAT), 'days')\n      let expiresId = `${daysUntilTGE}d`\n      let jwtOpts = {\n        expiresIn: expiresId,\n        jwtid: jwtid,\n        // subject: id,\n        issuer: process.env.ADMIN_EMAIL\n      }\n      return resolve(jwt.sign(payload, process.env.PK, jwtOpts))\n    } catch (e) {\n      return reject(e)\n    }\n  })\n}\n\nconst accessToken = function (id) {\n  return new Promise(function (resolve, reject) {\n    try {\n      let jwtid = uuid.v4()\n\n      let payload = {\n        sub: id,\n        type: TOKEN_TYPES.AUTH_TOKEN,\n        nonce: nonce()\n      }\n      let pk = Buffer.from(process.env.KEY, 'base64')\n      if (!pk) {\n        console.warn('Attempting to fall back to file')\n        pk = fs.readFileSync(`${process.env.PWD}/server.key`)\n      }\n\n      let jwtOpts = {\n        expiresIn: '1d',\n        jwtid: jwtid,\n        // subject: id,\n        issuer: process.env.ADMIN_EMAIL,\n        algorithm: 'RS256'\n      }\n      return resolve(jwt.sign(payload, pk.toString('utf8'), jwtOpts))\n    } catch (e) {\n      return reject(e)\n    }\n  })\n}\nconst verifyAccessToken = function (token) {\n  return new Promise(function (resolve, reject) {\n    try {\n      let pk = fs.readFileSync(`${process.env.PWD}/STAR_swytch_io.crt`)\n      jwt.verify(token, pk, {\n        maxAge: '1d', algorithms: ['RS256']\n      }, (tokenError, payLoad) => {\n        if (tokenError) {\n          return reject(tokenError)\n        }\n        return resolve(payLoad)\n      })\n    } catch (e) {\n      return reject(e)\n    }\n  })\n}\n\nconst refreshToken = function (id) {\n  return new Promise(function (resolve, reject) {\n    try {\n      let jwtid = uuid.v4()\n\n      let payload = {\n        sub: id,\n        type: TOKEN_TYPES.VERIFY_EMAIL_TOKEN,\n        nonce: nonce()\n      }\n      let tgeDate = moment(process.env.TGE_DATE, process.env.TGE_DATE_FORMAT)\n      let daysUntilTGE = tgeDate.diff(moment({}).format(process.env.TGE_DATE_FORMAT), 'days')\n      let expiresId = `${daysUntilTGE}d`\n      let jwtOpts = {\n        expiresIn: expiresId,\n        jwtid: jwtid,\n        // subject: id,\n        issuer: process.env.ADMIN_EMAIL\n      }\n      return resolve(jwt.sign(payload, process.env.PK, jwtOpts))\n    } catch (e) {\n      return reject(e)\n    }\n  })\n}\n/**\n *\n * @param jwt\n * @returns {Promise}\n */\nconst verifyToken = function (token) {\n  return new Promise(function (resolve, reject) {\n    try {\n      let tgeDate = moment(process.env.TGE_DATE, process.env.TGE_DATE_FORMAT)\n      let daysUntilTGE = tgeDate.diff(moment({}).format(process.env.TGE_DATE_FORMAT), 'days')\n      let expiresId = `${daysUntilTGE}d`\n      jwt.verify(token, process.env.PK, {maxAge: expiresId}, (tokenError, payLoad) => {\n        if (tokenError) {\n          return reject(tokenError)\n        }\n        return resolve(payLoad)\n      })\n    } catch (e) {\n      return reject(e)\n    }\n  })\n}\n\nconst generateAccessToken = function (req, res, next) {\n  req.session.token = req.session.token || {}\n  req.session.refreshToken = jwt.sign({id: req.user._id}, process.env.CS, {expiresIn: (120 * 60)})\n  next()\n}\n\nmodule.exports = {\n  confirmEmailToken,\n  generateAccessToken,\n  verifyToken,\n  accessToken,\n  refreshToken,\n  verifyAccessToken\n}\n\n\n// const generateToken = (req, res, next) => {\n//   if (!req.isAuthenticated()) {\n//     return next(new Error('Unauthorized'))\n//   }\n//\n//   if (req.session.token) {\n//     jwt.verify(req.session.token, config.cs, (err, decoded) => {\n//       if (err) {\n//         req.session.token = jwt.sign({id: req.user._id}, config.cs, {expiresIn: (120 * 60)})\n//       }\n//       return next()\n//     })\n//   } else {\n//     req.session.token = jwt.sign({id: req.user._id}, config.cs, {expiresIn: (120 * 60)})\n//     return next()\n//   }\n// }\n// function validateRefreshToken (req, res, next) {\n//   User.find({refreshToken: req.body}, function (err, user) {\n//     if (err) {\n//       return next(err);\n//     }\n//     req.user = user;\n//     next();\n//   });\n// }\n/*\n How to generate a long-lived token:\n Start with a short-lived token generated on a client and ship it back to your server.\n Use the user token, your app ID and app secret to make the following call from your server to Facebook's servers:\n */\n\n// function rejectToken (req, res, next) {\n//   db.client.rejectToken(req.body, next)\n// }\n\n// ////////////////////\n// token generation //\n// ////////////////////\n//\n// function generateRefreshToken (req, res, next) {\n//   if (req.query.permanent === 'true') {\n//     req.token.refreshToken = req.user.clientId.toString() + '.' + crypto.randomBytes(\n//       40).toString('hex')\n//     db.client.storeToken({\n//       id: req.user.clientId,\n//       refreshToken: req.token.refreshToken\n//     }, next)\n//   } else {\n//     next()\n//   }\n// }\n\n"]}