{"version":3,"sources":["../../lib/authenticate.js"],"names":["passport","require","moment","module","exports","req","res","next","hasCookie","authenticated","cookies","signedCookies","authenticate","err","user","info","Error","logIn","cookie","Date","now","httpOnly","maxAge","add","unix","signed","secure","process","env","NODE_ENV","path"],"mappings":"AAAA;;AACA,IAAMA,WAAWC,QAAQ,UAAR,CAAjB;AACA,IAAMC,SAASD,QAAQ,QAAR,CAAf;AACAE,OAAOC,OAAP,GAAiB,UAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;;AAEnC,WAASC,SAAT,CAAoBH,GAApB,EAAyB;AACvB,QAAII,gBAAgB,KAApB;AACA,QAAIJ,OAAOA,IAAIK,OAAf,EAAwB;AACtBD,sBAAgBJ,IAAIK,OAAJ,CAAY,SAAZ,CAAhB;AACA,UAAI,CAACD,aAAL,EAAoB;AAClBA,wBAAgBJ,IAAIM,aAAJ,CAAkB,SAAlB,CAAhB;AACD;AACF;AACD,WAAOF,aAAP;AACD;;AAEDT,WAASY,YAAT,CAAsB,OAAtB,EAA+B,UAAUC,GAAV,EAAeC,IAAf,EAAqBC,IAArB,EAA2B;AACxD,QAAIF,GAAJ,EAAS;AACP,aAAON,KAAKM,GAAL,CAAP;AACD;AACD;AACA,QAAIL,UAAUH,GAAV,CAAJ,EAAoB;AAClB,aAAOE,MAAP;AACD;;AAED,QAAI,CAACO,IAAL,EAAW;AACT;AACA,aAAOP,KAAK,IAAIS,KAAJ,CAAU,cAAV,CAAL,CAAP;AACD;AACDX,QAAIY,KAAJ,CAAUH,IAAV,EAAgB,UAAUD,GAAV,EAAe;AAC7B,UAAIA,GAAJ,EAAS;AACP,eAAON,KAAKM,GAAL,CAAP;AACD;AACDP,UAAIY,MAAJ,CAAW,SAAX,EAAsBC,KAAKC,GAAL,EAAtB,EAAkC;AAChCC,kBAAU,IADsB;AAEhCC,gBAAQpB,SAASqB,GAAT,CAAa,EAAb,EAAiB,OAAjB,EAA0BC,IAA1B,EAFwB;AAGhCC,gBAAQ,IAHwB;AAIhCC,gBAAQC,QAAQC,GAAR,CAAYC,QAAZ,KAAyB,aAJD;AAKhCC,cAAM;AAL0B,OAAlC;AAOAvB;AACD,KAZD;AAaD,GA1BD,EA0BGF,GA1BH,EA0BQC,GA1BR,EA0BaC,IA1Bb;AA2BD,CAxCD","file":"authenticate.js","sourcesContent":["'use strict'\nconst passport = require('passport')\nconst moment = require('moment')\nmodule.exports = (req, res, next) => {\n\n  function hasCookie (req) {\n    let authenticated = false\n    if (req && req.cookies) {\n      authenticated = req.cookies['su_user']\n      if (!authenticated) {\n        authenticated = req.signedCookies['su_user']\n      }\n    }\n    return authenticated\n  }\n\n  passport.authenticate('local', function (err, user, info) {\n    if (err) {\n      return next(err)\n    }\n    // if the login cookie is not expried proceed\n    if (hasCookie(req)) {\n      return next()\n    }\n\n    if (!user) {\n      // return res.status(404).json({error: 'Unauthorized'})\n      return next(new Error('Unauthorized'))\n    }\n    req.logIn(user, function (err) {\n      if (err) {\n        return next(err)\n      }\n      res.cookie('su_user', Date.now(), {\n        httpOnly: true,\n        maxAge: moment().add(24, 'hours').unix(),\n        signed: true,\n        secure: process.env.NODE_ENV !== 'development',\n        path: '/'\n      })\n      next()\n    })\n  })(req, res, next)\n}\n"]}