{"version":3,"sources":["../../lib/authenticate.js"],"names":["passport","require","moment","module","exports","req","res","next","hasCookie","authenticated","cookies","signedCookies","authenticate","err","user","info","redirect","_id","logIn","expires","cookie","httpOnly","Date","now","signed","secure","process","env","NODE_ENV","path"],"mappings":"AAAA;;AACA,IAAMA,WAAWC,QAAQ,UAAR,CAAjB;AACA,IAAMC,SAASD,QAAQ,QAAR,CAAf;AACAE,OAAOC,OAAP,GAAiB,UAACC,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;;AAEnC,WAASC,SAAT,CAAoBH,GAApB,EAAyB;AACvB,QAAII,gBAAgB,EAApB;AACA,QAAIJ,OAAOA,IAAIK,OAAf,EAAwB;AACtBD,sBAAgBJ,IAAIK,OAAJ,CAAY,SAAZ,CAAhB;AACA,UAAI,CAACD,aAAL,EAAoB;AAClBA,wBAAgBJ,IAAIM,aAAJ,CAAkB,SAAlB,CAAhB;AACD;AACF;AACD,WAAOF,aAAP;AACD;;AAEDT,WAASY,YAAT,CAAsB,OAAtB,EAA+B,UAAUC,GAAV,EAAeC,IAAf,EAAqBC,IAArB,EAA2B;AACxD,QAAIF,GAAJ,EAAS;AACP,aAAON,KAAKM,GAAL,CAAP;AACD;;AAED;AACA,QAAIR,IAAIS,IAAJ,IAAYN,UAAUH,GAAV,CAAhB,EAAgC;AAC9B,aAAOE,MAAP;AACD;;AAED,QAAI,CAACO,IAAD,IAAS,CAACN,UAAUH,GAAV,CAAd,EAA8B;AAC5B,aAAOC,IAAIU,QAAJ,CAAa,QAAb,CAAP;AACD;;AAED,QAAI,CAACF,IAAL,EAAW;AACTA,aAAO,EAACG,KAAKT,UAAUH,GAAV,CAAN,EAAP;AACD;;AAEDA,QAAIa,KAAJ,CAAUJ,IAAV,EAAgB,UAAUD,GAAV,EAAe;AAC7B,UAAIA,GAAJ,EAAS;AACP,eAAON,KAAKM,GAAL,CAAP;AACD;AACD;AACA,UAAI,CAACL,UAAUH,GAAV,CAAL,EAAqB;AACnB,YAAIc,UAAY,KAAK,EAAL,GAAU,EAAX,GAAiB,IAAhC;AACAb,YAAIc,MAAJ,CAAW,SAAX,EAAsBf,IAAIS,IAAJ,CAASG,GAA/B,EAAoC;AAClCI,oBAAU,IADwB;AAElCF,mBAAS,IAAIG,IAAJ,CAASA,KAAKC,GAAL,KAAaJ,OAAtB,CAFyB;AAGlCK,kBAAQ,IAH0B;AAIlCC,kBAAQC,QAAQC,GAAR,CAAYC,QAAZ,KAAyB,aAJC;AAKlCC,gBAAM;AAL4B,SAApC;AAOD;AACDtB;AACD,KAhBD;AAiBD,GAnCD,EAmCGF,GAnCH,EAmCQC,GAnCR,EAmCaC,IAnCb;AAoCD,CAjDD","file":"authenticate.js","sourcesContent":["'use strict'\nconst passport = require('passport')\nconst moment = require('moment')\nmodule.exports = (req, res, next) => {\n\n  function hasCookie (req) {\n    let authenticated = ''\n    if (req && req.cookies) {\n      authenticated = req.cookies['SU_USER']\n      if (!authenticated) {\n        authenticated = req.signedCookies['SU_USER']\n      }\n    }\n    return authenticated\n  }\n\n  passport.authenticate('local', function (err, user, info) {\n    if (err) {\n      return next(err)\n    }\n\n    // if the login cookie is not expried proceed\n    if (req.user && hasCookie(req)) {\n      return next()\n    }\n\n    if (!user && !hasCookie(req)) {\n      return res.redirect('/login')\n    }\n\n    if (!user) {\n      user = {_id: hasCookie(req)}\n    }\n\n    req.logIn(user, function (err) {\n      if (err) {\n        return next(err)\n      }\n      // 1 hour expiration\n      if (!hasCookie(req)) {\n        let expires = ((60 * 60 * 24) * 1000)\n        res.cookie('SU_USER', req.user._id, {\n          httpOnly: true,\n          expires: new Date(Date.now() + expires),\n          signed: true,\n          secure: process.env.NODE_ENV !== 'development',\n          path: '/'\n        })\n      }\n      next()\n    })\n  })(req, res, next)\n}\n"]}