{"version":3,"sources":["../../lib/passport.js"],"names":["LocalStrategy","require","Strategy","User","module","exports","passport","localStrategy","usernameField","passwordField","passReqToCallback","req","username","password","done","isAuthenticated","user","findOne","email","err","Error","message","comparePassword","matches","session","regenerate","toObject","serializeUser","_id","deserializeUser","id","findById","use"],"mappings":"AAAA;;AACA,IAAMA,gBAAgBC,QAAQ,gBAAR,EAA0BC,QAAhD;;eACeD,QAAQ,SAAR,C;IAARE,I,YAAAA,I;;AAEPC,OAAOC,OAAP,GAAiB,UAACC,QAAD,EAAc;AAC7B,MAAIC,gBAAgB,IAAIP,aAAJ,CAAkB;AACpCQ,mBAAe,OADqB;AAEpCC,mBAAe,KAFqB;AAGpCC,uBAAmB;AAHiB,GAAlB,EAIjB,UAAUC,GAAV,EAAeC,QAAf,EAAyBC,QAAzB,EAAmCC,IAAnC,EAAyC;AAC1C,QAAIH,IAAII,eAAJ,EAAJ,EAA2B;AACzB,aAAOD,KAAK,IAAL,EAAWH,IAAIK,IAAf,CAAP;AACD;;AAEDb,SAAKc,OAAL,CAAa,EAACC,OAAON,QAAR,EAAb,EAAgC,UAAUO,GAAV,EAAeH,IAAf,EAAqB;AACnD,UAAIG,GAAJ,EAAS;AACP,eAAOL,KAAKK,GAAL,CAAP;AACD;;AAED,UAAI,CAACH,IAAL,EAAW;AACT,eAAOF,KAAK,IAAIM,KAAJ,CAAU,qBAAV,CAAL,EAAuC,KAAvC,EAA8C,EAACC,SAAS,qBAAV,EAA9C,CAAP;AACD;;AAEDL,WAAKM,eAAL,CAAqBT,QAArB,EAA+B,UAACM,GAAD,EAAMI,OAAN,EAAkB;AAC/C,YAAIJ,OAAO,CAACI,OAAZ,EAAqB;AACnB,iBAAOT,KAAK,IAAIM,KAAJ,CAAU,qBAAV,CAAL,EAAuC,KAAvC,EAA8C,EAACC,SAAS,qBAAV,EAA9C,CAAP;AACD;AACDV,YAAIa,OAAJ,CAAYC,UAAZ,CAAuB,UAAUN,GAAV,EAAe;AACpC;AACA,iBAAOL,KAAK,IAAL,EAAWE,KAAKU,QAAL,EAAX,CAAP;AACD,SAHD;AAID,OARD;AASD,KAlBD;AAmBD,GA5BmB,CAApB;;AA8BApB,WAASqB,aAAT,CAAuB,UAAUX,IAAV,EAAgBF,IAAhB,EAAsB;AAC3CA,SAAK,IAAL,EAAWE,KAAKY,GAAhB;AACD,GAFD;;AAIAtB,WAASuB,eAAT,CAAyB,UAAUC,EAAV,EAAchB,IAAd,EAAoB;AAC3CX,SAAK4B,QAAL,CAAcD,EAAd,EAAkB,UAAUX,GAAV,EAAeH,IAAf,EAAqB;AACrCF,WAAKK,GAAL,EAAUH,KAAKU,QAAL,EAAV;AACD,KAFD;AAGD,GAJD;AAKApB,WAAS0B,GAAT,CAAazB,aAAb;AACD,CAzCD","file":"passport.js","sourcesContent":["'use strict'\nconst LocalStrategy = require('passport-local').Strategy\nconst {User} = require('./model')\n\nmodule.exports = (passport) => {\n  let localStrategy = new LocalStrategy({\n    usernameField: 'email',\n    passwordField: 'pwd',\n    passReqToCallback: true\n  }, function (req, username, password, done) {\n    if (req.isAuthenticated()) {\n      return done(null, req.user)\n    }\n\n    User.findOne({email: username}, function (err, user) {\n      if (err) {\n        return done(err)\n      }\n\n      if (!user) {\n        return done(new Error('Incorrect username.'), false, {message: 'Incorrect username.'})\n      }\n\n      user.comparePassword(password, (err, matches) => {\n        if (err || !matches) {\n          return done(new Error('Incorrect password.'), false, {message: 'Incorrect password.'})\n        }\n        req.session.regenerate(function (err) {\n          // will have a new session here\n          return done(null, user.toObject())\n        })\n      })\n    })\n  })\n\n  passport.serializeUser(function (user, done) {\n    done(null, user._id)\n  })\n\n  passport.deserializeUser(function (id, done) {\n    User.findById(id, function (err, user) {\n      done(err, user.toObject())\n    })\n  })\n  passport.use(localStrategy)\n}\n"]}